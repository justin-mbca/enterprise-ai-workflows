name: Deploy Project 3 (RAG) to Hugging Face Space

on:
  push:
    branches: [ main ]
    paths:
      - 'project3-document-qa/**'
  workflow_dispatch:

jobs:
  deploy:
    name: Upload folder to HF Space
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install huggingface_hub==0.24.6

      - name: Upload project3-document-qa to Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_SPACE_ID: zhangju2023/document-qa-rag
        run: |
          python - << 'PY'
          from huggingface_hub import HfApi
          import os

          token = os.environ.get('HF_TOKEN')
          space_id = os.environ.get('HF_SPACE_ID')
          folder = 'project3-document-qa'

          if not token:
              raise SystemExit('Missing HF_TOKEN secret. Create a WRITE token in Hugging Face and add it to repo secrets as HF_TOKEN.')

          api = HfApi(token=token)

          # Create the Space if it doesn't exist (idempotent; will fail silently if exists)
          try:
              api.create_repo(repo_id=space_id, repo_type='space', space_sdk='gradio', private=False)
          except Exception:
              pass

          # Upload folder (sync mode overwrites updated files only)
          api.upload_folder(
              folder_path=folder,
              repo_id=space_id,
              repo_type='space',
              commit_message='CI: sync project3-document-qa to Space',
              allow_patterns=['app.py','requirements.txt','README.md','*.md','**/*.py','**/*.txt'],
          )
          print('âœ… Upload completed')
          PY
